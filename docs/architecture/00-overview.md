# 00. Overview

## Цель
Построить высоконагруженную вики-систему, оптимизированную под **read-heavy** нагрузку, без брокеров сообщений.

## Основные принципы
1. **HTTP только на краю**: клиенты общаются с **api.gateway** по HTTP, внутри — **gRPC**.
2. **Контракты = истина**: все сущности/методы описаны в **protobuf** и версионируются через `invenlore/proto`.
3. **CQRS-подход** (на практике):
   - `wiki-write` держит канонику и принимает изменения.
   - `wiki-read` обслуживает быстрые чтения из денормализованной read-модели + кэшей.
4. **Без брокера**: асинхронные процессы делаем через **transactional outbox** в Mongo и воркеры с **polling + leases**.
5. **Идемпотентность на write**: поддержка `Idempotency-Key` на внешнем API, чтобы ретраи не создавали дубли.
6. **Наблюдаемость**: request_id сквозной, метрики на каждом RPC, структурные логи.

## Сервисы (ядро)
- api.gateway — HTTP → gRPC, auth/limits/error mapping
- identity — identity/auth (JWT/JWKS), RBAC/Authorize
- wiki-write — создание/изменение страниц и ревизий, outbox событий
- wiki-read — быстрые чтения из read-модели + Redis
- render — Markdown → HTML, оглавление, превью
- search — индексирование/поиск (OpenSearch/ES), воркер из outbox
- media — S3-вложения, пресайны, превью

## Хранилища
- MongoDB (MVP single node): каноника, read-модель (на старте можно в одной ноде разными БД/коллекциями)
- Redis: кэш, rate-limit, короткие locks
- S3 (Yandex Object Storage): вложения, превью
- OpenSearch/Elasticsearch: полнотекстовый поиск (можно после MVP)

## Высокая нагрузка: “что делает систему быстрой”
- Чтение страницы — 1 hop: gateway → wiki-read (и кэш).
- Страница кэшируется по ключу “page_id + revision_id” → инвалидации почти нет.
- Write-транзакция короткая: создать ревизию + outbox запись.
- Рендер/индексация — воркеры из outbox, масштабируются отдельно.

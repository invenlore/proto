sequenceDiagram
  autonumber
  participant C as Client
  participant G as api.gateway
  participant W as wiki-write
  participant M as Mongo (write)
  participant O as Outbox (Mongo)
  participant R as render worker
  participant RM as Mongo (read-model)

  C->>G: PATCH /v1/wiki/pages/{id} (Idempotency-Key)
  G->>W: gRPC UpdatePage (metadata: user_id, idempotency_key, request_id)
  W->>M: insert revision + update page head
  W->>O: insert outbox event PageRevisionCreated
  W-->>G: new_revision_id
  G-->>C: 200

  R->>O: claim event (lease)
  R->>RM: upsert page_snapshot(page_id:rev_id)
  R->>RM: update page_head(head_revision_id)
  R->>O: mark done

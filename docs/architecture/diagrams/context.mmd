flowchart LR
  Client[Clients] -->|HTTP| GW[api.gateway]
  GW -->|gRPC| ID[identity]
  GW -->|gRPC| WR[wiki-write]
  GW -->|gRPC| RD[wiki-read]
  GW -->|gRPC| MED[media]
  GW -->|gRPC| SRCH[search]

  %% Canonical storage (MVP: same Mongo node)
  WR --> MONGO[(MongoDB)]
  ID --> MONGO
  MED --> MONGO

  %% Read model (logical separation; physically same Mongo in MVP)
  RD --> RM
  RM[(MongoDB - read model)]

  %% Cache
  RD --> REDIS[(Redis)]
  GW --> REDIS

  %% External stores
  MED --> S3[(Yandex Object Storage)]
  SRCH --> OS[(OpenSearch/Elasticsearch)]

  %% No-broker async pipeline via outbox (stored in Mongo)
  WR --> OUT
  OUT[Outbox - MongoDB]

  OUT --> RENDER[render worker]
  OUT --> SRCHIDX[search indexer]
  OUT --> MEDW[media worker]

  %% Consumers write results into read model / indexes / object storage
  RENDER --> RM
  SRCHIDX --> OS
  MEDW --> S3

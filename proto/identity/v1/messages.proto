syntax = "proto3";

// Identity domain messages for authentication, profile, and admin APIs.
package identity.v1;

option go_package = "github.com/invenlore/proto/pkg/identity/v1;identityv1";

// User represents a full user record used across public and admin APIs.
message User {
	// Stable user identifier.
	string id = 1;
	// Display name of the user.
	string name = 2;
	// Email address of the user.
	string email = 3;
	// Assigned roles/scopes for authorization.
	repeated string roles = 4;
	// Global permissions (RBAC).
	repeated string perms_global = 5;
	// Project-scoped permissions (RBAC).
	repeated string perms_project = 6;
	// Allowed project scopes (RBAC).
	repeated string scopes = 7;
	// Created timestamp (unix seconds).
	int64 created_at = 8;
	// Updated timestamp (unix seconds).
	int64 updated_at = 9;
}

// Minimal user data without PII.
message UserBrief {
	// Stable user identifier.
	string id = 1;
	// Display name of the user.
	string name = 2;
}

// Supported OAuth providers.
enum OAuthProvider {
	OAUTH_PROVIDER_UNSPECIFIED = 0;
	OAUTH_PROVIDER_GITHUB = 1;
}

// Starts OAuth authorization flow.
message StartOAuthRequest {
	// OAuth provider.
	OAuthProvider provider = 1;
	// Optional redirect destination (relative or absolute).
	string redirect_uri = 2;
}

// OAuth start response with provider URL and state.
message StartOAuthResponse {
	// Provider authorization URL.
	string authorization_url = 1;
	// CSRF/PKCE state token.
	string state = 2;
}

// Completes OAuth flow using provider code.
message CompleteOAuthRequest {
	// OAuth provider.
	OAuthProvider provider = 1;
	// Authorization code from provider.
	string code = 2;
	// State token from start step.
	string state = 3;
}

// OAuth completion response with issued tokens.
message CompleteOAuthResponse {
	// Short-lived access token (JWT).
	string access_token = 1;
	// Refresh token for token rotation.
	string refresh_token = 2;
	// Access token TTL in seconds.
	int64 expires_in_seconds = 3;
	// User snapshot.
	User user = 4;
	// Redirect destination associated with the OAuth state.
	string redirect_uri = 5;
}

// Request to register a new user.
message RegisterRequest {
	// Email used as login.
	string email = 1;
	// Password in plain text (hashed server-side).
	string password = 2;
	// Display name.
	string name = 3;
}

// Result of successful registration.
message RegisterResponse {
	// Newly created user id.
	string id = 1;
	// Created user record.
	User user = 2;
}

// Request to authenticate a user.
message LoginRequest {
	// Login email.
	string email = 1;
	// User password.
	string password = 2;
}

// Authentication response with tokens.
message LoginResponse {
	// Short-lived access token (JWT).
	string access_token = 1;
	// Refresh token used to rotate access tokens.
	string refresh_token = 2;
	// Access token TTL in seconds.
	int64 expires_in_seconds = 3;
	// User snapshot.
	User user = 4;
}

// Request to refresh tokens.
message RefreshRequest {
	// Previously issued refresh token.
	string refresh_token = 1;
}

// Response with refreshed tokens.
message RefreshResponse {
	string access_token = 1;
	string refresh_token = 2;
	int64 expires_in_seconds = 3;
}

// Request to revoke a refresh token.
message LogoutRequest {
	// Refresh token to revoke.
	string refresh_token = 1;
}

// Logout response.
message LogoutResponse {}

// Request current user profile.
message GetProfileRequest {}

// Profile response for the current user.
message GetProfileResponse {
	User user = 1;
}

// Request to update profile fields.
message UpdateProfileRequest {
	// Updated display name.
	string name = 1;
}

// Profile update response.
message UpdateProfileResponse {
	User user = 1;
}

// Request to fetch JWKS.
message GetJWKSRequest {}

// Response containing JSON Web Key Set.
message GetJWKSResponse {
	JWKSet jwks = 1;
}

// JSON Web Key Set.
message JWKSet {
	repeated JWK keys = 1;
}

// JSON Web Key entry for RSA or EC keys.
message JWK {
	string kid = 1;
	string kty = 2;
	string use = 3;
	string alg = 4;
	string n = 5;
	string e = 6;
	string crv = 7;
	string x = 8;
	string y = 9;
}

// Request to validate a token (optional helper endpoint).
message ValidateTokenRequest {
	string token = 1;
}

// Result of token validation.
message ValidateTokenResponse {
	string id = 1;
	repeated string roles = 2;
	repeated string perms_global = 3;
	repeated string perms_project = 4;
	repeated string scopes = 5;
}

// Request for fine-grained authorization.
message AuthorizeRequest {
	string id = 1;
	string action = 2;
	string resource = 3;
}

// Authorization decision.
message AuthorizeResponse {
	bool allowed = 1;
}

// Request for minimal user info.
message GetUserBriefRequest {
	string id = 1;
}

// Response with minimal user info.
message GetUserBriefResponse {
	UserBrief user = 1;
}

// Request to create a new user from admin API.
message AddUserRequest {
	User user = 1;
}

// Response for created user.
message AddUserResponse {
	string id = 1;
}

// Request to fetch a user by id.
message GetUserRequest {
	string id = 1;
}

// Response with user data.
message GetUserResponse {
	User user = 1;
}

// Request to delete a user.
message DeleteUserRequest {
	string id = 1;
}

// Response for delete operation.
message DeleteUserResponse {}

// Request to list users.
message ListUsersRequest {
	int32 page_size = 1;
	string page_token = 2;
}

// Response with users and pagination info.
message ListUsersResponse {
	repeated User users = 1;
	string next_page_token = 2;
}
